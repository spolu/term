<!DOCTYPE html>

<html>
<head>
  <title>vt.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="common.html">
                common.js
              </a>
            
              
              <a class="source" href="factory.html">
                factory.js
              </a>
            
              
              <a class="source" href="utf8.html">
                utf8.js
              </a>
            
              
              <a class="source" href="char_map.html">
                char_map.js
              </a>
            
              
              <a class="source" href="colors.html">
                colors.js
              </a>
            
              
              <a class="source" href="vt.html">
                vt.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>vt.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/**
 * mt: vt.js
 *
 * Copyright (c) 2013, Stanislas Polu. All rights reserved.
 * (see LICENSE file)
 *
 */</span>
<span class="keyword">var</span> fwk = require(<span class="string">'fwk'</span>);
<span class="keyword">var</span> events = require(<span class="string">'events'</span>);
<span class="keyword">var</span> util = require(<span class="string">'util'</span>);
<span class="keyword">var</span> factory = require(<span class="string">'../factory.js'</span>).factory;

<span class="string">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>PARSE_STATE</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Helper class to represent the parser state</p>
<pre><code>@spec {object} { def_fun }</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> parse_state = <span class="keyword">function</span>(spec, my) {
  <span class="keyword">var</span> _super = {};
  my = my || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4>Private members</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.def_fun = spec.def_fun
  my.buf = <span class="literal">null</span>;
  my.pos = <span class="number">0</span>;
  my.fun = my.def_fun;
  my.args = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4>Public methods</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> reset_fun;   <span class="comment">/* reset_fun(); */</span>
  <span class="keyword">var</span> reset_buf;   <span class="comment">/* reset_buf([buf]); */</span>
  <span class="keyword">var</span> reset_args   <span class="comment">/* reset_args(); */</span>
  <span class="keyword">var</span> reset;       <span class="comment">/* reset([buf]); */</span>
  <span class="keyword">var</span> int_arg;     <span class="comment">/* int_arg(pos, [def_value]); */</span>
  <span class="keyword">var</span> advance;     <span class="comment">/* advance(count); */</span>
  <span class="keyword">var</span> peek_buf;    <span class="comment">/* peek_buf(); */</span>
  <span class="keyword">var</span> peek;        <span class="comment">/* peek(); */</span>
  <span class="keyword">var</span> consume;     <span class="comment">/* consume(); */</span>
  <span class="keyword">var</span> is_complete; <span class="comment">/* is_complete(); */</span>
  
  <span class="keyword">var</span> that = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>reset_fun</h3>
<p>Resets the parser function only.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset_fun = <span class="keyword">function</span>() {
    my.fun = my.def_fun;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>reset_buf</h3>
<pre><code>@buf {string} optional value for buffer (defaults to null)</code></pre>
<p>Resets the buffer and position only.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset_buf = <span class="keyword">function</span>(buf) {
    my.buf = (<span class="keyword">typeof</span> buf === <span class="string">'string'</span>) ? buf : <span class="literal">null</span>;
    my.pos = <span class="number">0</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>reset_args</h3>
<pre><code>@arg {string} optional value for args[0]</code></pre>
<p>Resets the arguments list only</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset_args = <span class="keyword">function</span>(arg) {
    my.args = [];
    <span class="keyword">if</span>(<span class="keyword">typeof</span> arg !== <span class="string">'undefined'</span>) {
      my.args[<span class="number">0</span>] = arg;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3>reset</h3>
<pre><code>@buf {string} optional value for buffer</code></pre>
<p>Reset the parser state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset = <span class="keyword">function</span>(buf) {
    that.reset_fun();
    that.reset_buf(buf);
    that.reset_args();
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3>int_arg</h3>
<pre><code>@pos {number} the argument number to retrieve
@def {numnber} the default value to return</code></pre>
<p>Get an argument as an integer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  int_arg = <span class="keyword">function</span>(pos, def) {
    <span class="keyword">var</span> str = my.args[pos];
    <span class="keyword">if</span>(str) {
      <span class="keyword">var</span> ret = parseInt(str, <span class="number">10</span>);
      <span class="keyword">if</span>(ret === <span class="number">0</span>)
        ret = def;
      <span class="keyword">return</span> ret;
    }
    <span class="keyword">return</span> def;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3>advance</h3>
<pre><code>@count {number} the number of bytes to advance</code></pre>
<p>Advances the parse position </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  advance = <span class="keyword">function</span>(count) {
    my.pos += count;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3>peek_buf</h3>
<p>Return the remaining portion of the buffer without affecting
the parse_state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  peek_buf = <span class="keyword">function</span>() {
    <span class="keyword">return</span> my.buf.substr(my.pos);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3>peek</h3>
<p>Return the next character of the buffer without affecting the 
parse_state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  peek = <span class="keyword">function</span>() {
    <span class="keyword">return</span> my.buf.substr(my.pos, <span class="number">1</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3>consume_char</h3>
<p>Return the next character in the buffer and advance the parse
position of one byte.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  consume = <span class="keyword">function</span>() {
    <span class="keyword">return</span> my.buf.substr(my.pos++, <span class="number">1</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3>is_complete</h3>
<p>Returns whether the buffer is empty or the position is past
the end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  is_complete = <span class="keyword">function</span>() {
    <span class="keyword">return</span> my.buf === <span class="literal">null</span> || my.buf.length &lt;= my.pos;
  };


  fwk.method(that, <span class="string">'reset_fun'</span>, reset_fun, _super);
  fwk.method(that, <span class="string">'reset_buf'</span>, reset_buf, _super);
  fwk.method(that, <span class="string">'reset_args'</span>, reset_args, _super);
  fwk.method(that, <span class="string">'reset'</span>, reset, _super);
  fwk.method(that, <span class="string">'int_arg'</span>,int_arg , _super);
  fwk.method(that, <span class="string">'advance'</span>, advance, _super);
  fwk.method(that, <span class="string">'peek_buf'</span>, peek_buf, _super);
  fwk.method(that, <span class="string">'peek'</span>, peek, _super);
  fwk.method(that, <span class="string">'consume'</span>, consume, _super);
  fwk.method(that, <span class="string">'is_complete'</span>, is_complete, _super);

  fwk.getter(that, <span class="string">'buf'</span>, my, <span class="string">'buf'</span>);
  fwk.getter(that, <span class="string">'pos'</span>, my, <span class="string">'pos'</span>);
  fwk.getter(that, <span class="string">'fun'</span>, my, <span class="string">'fun'</span>);
  fwk.setter(that, <span class="string">'fun'</span>, my, <span class="string">'fun'</span>);

  <span class="keyword">return</span> that;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2>CURSOR_STATE</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Helper class to store and revert a cursor state used in DECSC</p>
<pre><code>@spec {object} { vt }</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> cursor_state = <span class="keyword">function</span>(spec, my) {
  <span class="keyword">var</span> _super = {};
  my = my || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h4>Private members</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.vt = spec.vt</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h4>Public methods</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> save;    <span class="comment">/* save(); */</span>
  <span class="keyword">var</span> restore; <span class="comment">/* save(); */</span>
  
  <span class="keyword">var</span> that = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h3>save</h3>
<p>Save the cursor state from the VT associaged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  save = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>TODO
this.cursor = this.vt<em>.terminal.saveCursor();
this.textAttributes = this.vt</em>.terminal.getTextAttributes().clone();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    my.GL = my.vt.GL();
    my.GR = my.vt.GR();

    my.G0 = my.vt.G0();
    my.G1 = my.vt.G1();
    my.G2 = my.vt.G2();
    my.G3 = my.vt.G3();
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h3>restore</h3>
<p>Restores the previously saved cursor state to the VT associated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  restore = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>TODO
this.vt<em>.terminal.restoreCursor(this.cursor);
this.vt</em>.terminal.setTextAttributes(this.textAttributes.clone());</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h3>initialization</h3>
<p>We first start by saving the current VT sate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  save();

  fwk.method(that, <span class="string">'save'</span>, save, _super);
  fwk.method(that, <span class="string">'restore'</span>, restore, _super);

  <span class="keyword">return</span> that;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2>VT</h2>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Escape sequence interpreter </p>
<p>The <code>vt</code> object is in charge of parsing and interpreting the
sequence sent to the terminal and pass them to the terminal
to execute cursor operations.</p>
<h4>Guides:</h4>
<ul>
<li>[VT100] VT100 User Guide
<a href="http://vt100.net/docs/vt100-ug/chapter3.html">http://vt100.net/docs/vt100-ug/chapter3.html</a></li>
<li>[VT510] VT510 Video Terminal Programmer Information
<a href="http://vt100.net/docs/vt510-rm/contents">http://vt100.net/docs/vt510-rm/contents</a></li>
<li>[XTERM] Xterm Control Sequences
<a href="http://invisible-island.net/xterm/ctlseqs/ctlseqs.html">http://invisible-island.net/xterm/ctlseqs/ctlseqs.html</a></li>
<li>[CTRL]  Wikipedia: C0 and C1 Control Codes
<a href="http://en.wikipedia.org/wiki/C0_and_C1_control_codes">http://en.wikipedia.org/wiki/C0_and_C1_control_codes</a></li>
<li>[CSI]   Wikipedia: ANSI Escape Code
<a href="http://en.wikipedia.org/wiki/Control_Sequence_Introducer">http://en.wikipedia.org/wiki/Control_Sequence_Introducer</a></li>
</ul>
<pre><code>@spec {object} { 
    allow_width_change, 
    osc_time_limit,
    max_string_sequence,
    warn
 }</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> vt = <span class="keyword">function</span>(spec, my) {
  <span class="keyword">var</span> _super = {};
  my = my || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h4>Protected methods</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> parse_unknown;  <span class="comment">/* parse_unknown(); */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h4>Private methods</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> parse_unknown;                 <span class="comment">/* parse_unknown(); */</span>
  <span class="keyword">var</span> parse_csi;                     <span class="comment">/* parse_csi(); */</span>
  <span class="keyword">var</span> parse_until_string_terminator; <span class="comment">/* parse_until_string_terminator */</span>
  <span class="keyword">var</span> dispatch;                      <span class="comment">/* dispatch(); */</span>
  <span class="keyword">var</span> ignore;                        <span class="comment">/* ignore(); */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h4>Private members</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.parse_state = parse_state(parse_unknown);
  my.leading_modifier = <span class="string">''</span>;
  my.trailing_modifier = <span class="string">''</span>;
  my.allow_width_change = spec.allow_width_change || <span class="literal">false</span>;
  my.osc_time_limit = spec.osc_time_limit || <span class="number">20000</span>;
  my.max_string_sequence = spec.max_string_sequence || <span class="number">1024</span>;
  my.warn = spec.warn || <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h4>Public methods</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> reset;      <span class="comment">/* reset(); */</span>
  <span class="keyword">var</span> read;       <span class="comment">/* read(); */</span>
  
  <span class="keyword">var</span> that = <span class="keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h3>reset</h3>
<p>Resets the VT to its initial default state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset = <span class="keyword">function</span>() {
    my.G0 = require(<span class="string">'./char_map.js'</span>).maps[<span class="string">'B'</span>];
    my.G1 = require(<span class="string">'./char_map.js'</span>).maps[<span class="string">'0'</span>];
    my.G2 = require(<span class="string">'./char_map.js'</span>).maps[<span class="string">'B'</span>];
    my.G3 = require(<span class="string">'./char_map.js'</span>).maps[<span class="string">'B'</span>];

    my.GL = <span class="string">'G0'</span>;
    my.GR = <span class="string">'G0'</span>;

    my.saved_state = cursor_state({ vt: that });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h3>read</h3>
<pre><code>@buf The string bufffer to read</code></pre>
<p>Reads a string of character, inteprets it and pass it the the
underlying terminal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  read = <span class="keyword">function</span>(buf) {
    my.parse_state.reset_buf(buf.toString(<span class="string">'utf8'</span>));

    <span class="keyword">while</span>(!my.parse_state.is_complete()) {
      <span class="keyword">var</span> fun = my.parse_state.fun();
      <span class="keyword">var</span> buf = my.parse_state.buf();
      <span class="keyword">var</span> pos = my.parse_state.pos();

      my.parse_state.fun();
      <span class="keyword">if</span>(my.parse_state.fun() === fun &amp;&amp;
         my.parse_state.buf() === buf &amp;&amp;
         my.parse_state.pos() === pos) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Parser `fun` failed to alter state'</span>);
      }
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h3>parse_unknown</h3>
<p>Default parse function. Scans the string for 1-byte control character
(C0/C1 from [CTRL]). Any plain text coming before the code will be printed
normally to the terminal, the the control character will be dispatched.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parse_unknown = <span class="keyword">function</span>() {
    <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">(str)</span> {</span>
      <span class="keyword">var</span> str;
      <span class="keyword">if</span>(my[my.GL].GL)
         str = my[my.GL].GL(str);
      <span class="keyword">if</span>(my[my.GR].RL)
         str = my[my.GR].GR(str);
     that.emit(<span class="string">'term_print'</span>, str);
    }

    <span class="keyword">var</span> buf = my.parse_state.peek_buf();
    <span class="keyword">var</span> next_control = buf.search(my.cc1_r);

    <span class="keyword">if</span>(next_control === <span class="number">0</span>) {
      <span class="comment">/* We just stumbled into a control character */</span>
      dispatch(<span class="string">'CC1'</span>, buf.substr(<span class="number">0</span>, <span class="number">1</span>));
      my.parse_state.advance(<span class="number">1</span>);
    }
    <span class="keyword">else</span> <span class="keyword">if</span>(next_control === -<span class="number">1</span>) {
      <span class="comment">/* No control character, we print */</span>
      print(buf);
      my.parse_state.reset();
    }
    <span class="keyword">else</span> {
      print(buf.substr(<span class="number">0</span>, next_control));
      <span class="keyword">this</span>.dipatch(<span class="string">'CC1'</span>, buf.substr(next_control, <span class="number">1</span>));
      my.parse_state.advance(next_control + <span class="number">1</span>);
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h3>parse_csi</h3>
<p>Parse a Control Sequence Introducer code and dispatch it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parse_csi = <span class="keyword">function</span>() {
    <span class="keyword">var</span> ch = my.parse_state.peek();
    <span class="keyword">var</span> args = my.parse_state.args();

    <span class="keyword">if</span>(ch &gt;= <span class="string">'@'</span> &amp;&amp; ch &lt;= <span class="string">'~'</span>) {
      <span class="comment">/* This is the final character */</span>
      dispatch(<span class="string">'CSI'</span>, my.leading_modifier + my.trailing_modifier + ch);
      my.parse_state.reset_fun();
    }
    <span class="keyword">else</span> <span class="keyword">if</span>(ch === <span class="string">';'</span>) {
      <span class="comment">/* Parameter delimiter */</span>
      <span class="keyword">if</span>(my.trailing_modifier) {
        <span class="comment">/* Parameter delimiter after the trailing modifier. paddlin' */</span>
        parse_state.reset_fun();
      }
      <span class="keyword">else</span> {
        <span class="keyword">if</span>(!args.length) {
          <span class="comment">/* They omitted the first param. we supply it */</span>
          args.push(<span class="string">''</span>);
        }
        args.push(<span class="string">''</span>);
      }
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>) {
      <span class="keyword">if</span>(my.trailing_modifier) {
        parse_state.reset_fun();
      }
      <span class="keyword">else</span> <span class="keyword">if</span>(!args.length) {
        args[<span class="number">0</span>] = ch;
      }
      <span class="keyword">else</span> {
        args[args.length - <span class="number">1</span>] += ch;
      }
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (ch &gt;= <span class="string">' '</span> &amp;&amp; ch &lt;= <span class="string">'?'</span> &amp;&amp; ch != <span class="string">':'</span>) {
      <span class="keyword">if</span>(!args.length) {
        my.leading_modifier += ch;
      }
      <span class="keyword">else</span> {
        my.trailing_modifier += ch;
      }
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (my.cc1_r.test(ch)) {
      dispatch(<span class="string">'CC1'</span>, ch);
    }
    <span class="keyword">else</span> {
      parse_state.reset_fun();
    }
    my.parse_state.advance(<span class="number">1</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h3>parse_until_string_terminator</h3>
<pre><code>@return {boolean} if true, parsing is complete else it exceeded</code></pre>
<p>Skip over the string until the next String Terminator (ST, &#39;ESC \&#39;) or
Bell (BEL, &#39;\x07&#39;)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parse_until_string_terminator = <span class="keyword">function</span>() {
    <span class="keyword">var</span> buf = my.parse_state.peek_buf();
    <span class="keyword">var</span> next_terminator = buf.search(<span class="regexp">/(\x1b\\|\x07)/</span>);
    <span class="keyword">var</span> args = my.parse_state.args();

    <span class="keyword">if</span>(!args.length) {
      args[<span class="number">0</span>] = <span class="string">''</span>;
      args[<span class="number">1</span>] = <span class="keyword">new</span> Date();
    }

    <span class="keyword">if</span>(next_terminator === -<span class="number">1</span>) {
      <span class="comment">/* No terminator here, have to wait for the next string */</span>
      args[<span class="number">0</span>] += buf;

      <span class="keyword">var</span> abort;
      <span class="keyword">if</span>(args[<span class="number">0</span>].length &gt; my.max_string_sequence)
        abort = <span class="string">'Too long: '</span> + args[<span class="number">0</span>].length;
      <span class="keyword">if</span>(args[<span class="number">0</span>].indexOf(<span class="string">'\x1b'</span>) !== -<span class="number">1</span>)
        abort = <span class="string">'Embedded escape: '</span> + args[<span class="number">0</span>].indexOf(<span class="string">'\x1b'</span>);
      <span class="keyword">if</span>(<span class="keyword">new</span> Date() - args[<span class="number">1</span>] &gt; my.osc_time_limit)
        abort = <span class="string">'Timeout expired: '</span> + (<span class="keyword">new</span> Date() - args[<span class="number">1</span>]);

      <span class="keyword">if</span>(abort) {
        console.log(<span class="string">'`parse_until_string_terminator` aborting: '</span> + abort + <span class="string">' ['</span> + args[<span class="number">0</span>] + <span class="string">']'</span>);
        my.parse_state.reset(args[<span class="number">0</span>]);
        <span class="keyword">return</span> <span class="literal">false</span>;
      }
      
      my.parse_state.advance(buf.length);
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">else</span> <span class="keyword">if</span>((args[<span class="number">0</span>].length + next_terminator) &gt; my.max_string_sequence) {
      <span class="comment">/* Found the end of sequence but it's too long */</span>
      my.parse_state.reset(args[<span class="number">0</span>] + buf);
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">else</span> {
      <span class="comment">/* Found the terminator. String is accumulated in args[0] */</span>
      args[<span class="number">0</span>] += buf.substr(<span class="number">0</span>, next_terminator);
      my.parse_state.reset_fun();
      my.parse_state.advance(next_terminator +
                             (buf.substr(next_terminator, <span class="number">1</span>) === <span class="string">'\x1b'</span> ? <span class="number">2</span> : <span class="number">1</span>));
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h3>dispatch</h3>
<pre><code>@type {string} the escape sequence type
@code {string} the escape sequence code</code></pre>
<p>Dispatch to the function that handles the given CC1, ESC, CSI or VT52 code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dispatch = <span class="keyword">function</span>(type, code) {
    <span class="keyword">var</span> handler = my[type][code];
    <span class="keyword">if</span>(!handler || handler === ignore) {
      <span class="keyword">if</span>(my.warn) {
        console.log(<span class="string">'Unknown/Ignore '</span> + type + <span class="string">' code: '</span> + JSON.stringify(code));
      }
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span>(type === <span class="string">'CC1'</span> &amp;&amp; code &gt; <span class="string">'\x7f'</span>) {
      <span class="comment">/* We don't handle 8-bit controls. So let's just ignore */</span>
      <span class="keyword">if</span>(my.warn) {
        console.log(<span class="string">'Ignored 8-bit control code: 0x'</span> + 
                    code.charCodeAt(<span class="number">0</span>).toString(<span class="number">16</span>));
      }
      <span class="keyword">return</span>;
    }
    <span class="keyword">return</span> handler(code);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h3>ignore</h3>
<p>Ignore handler use to ignore an action and test equality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ignore = <span class="keyword">function</span>() {};

  <span class="comment">/********************************************************************************/</span>
  <span class="comment">/*                              CONSTROL SEQUENCES                              */</span>
  <span class="comment">/********************************************************************************/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h3>CC1</h3>
<p>Collection of control chracters expressed in a single byte.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.CC1 = {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Null (NUL)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x00'</span>: <span class="keyword">function</span>() {},</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Enquiry (ENQ)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x05'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Ring Bell (BEL)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x07'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_ring_bell'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Backspace (BS)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x08'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_cursor_left'</span>, <span class="number">1</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Horizontal Tab (HT)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x09'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_forward_tab_stop'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Line Feed (LF)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x0a'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_form_feed'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Vertical Tab (VT)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x0b'</span>: my.CC1[<span class="string">'\x0a'</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Form Feed (FF)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x0c'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_form_feed'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Carriage Return (CR)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x0d'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_set_cursor_column'</span>, <span class="number">0</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Shift Out (SO), aka Lock Shift 1 (LS1)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x0e'</span>: <span class="keyword">function</span>() {
      my.GL = <span class="string">'G1'</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Shift In (SI), aka Lock Shift 0 (LS0)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x0f'</span>: <span class="keyword">function</span>() {
      my.GL = <span class="string">'G0'</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Transmit On (XON)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x11'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Transmit Off (XOFF)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x13'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Cancel (CAN)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x18'</span>: <span class="keyword">function</span>() {
      my.parse_state.reset_fun();
      that.emit(<span class="string">'term_print'</span>, <span class="string">'?'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Substitute (SUB)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x1a'</span>: my.CC1[<span class="string">'\x18'</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Escape (ESC)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x1b'</span>: <span class="keyword">function</span>() {
      <span class="function"><span class="keyword">function</span> <span class="title">parse_esc</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> ch = my.parse_state.consume();
        <span class="keyword">if</span>(ch === <span class="string">'\x1b'</span>)
          <span class="keyword">return</span>;
        dispatch(<span class="string">'ESC'</span>, ch);
        <span class="keyword">if</span>(my.parse_sate.fun() === parse_esc)
          my.parse_state.reset_fun();
      };
      my.parse_state.set_fun(parse_esc);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Delete (DEL)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x7f'</span>: ignore
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <h3>CC1 Regexp</h3>
<p>Constructed to quickly scan the known 1-byte control chars</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> acc = Object.keys(my.CC1).map(<span class="keyword">function</span>(e) {
    <span class="keyword">return</span> <span class="string">'\\x'</span> + fwk.zpad(e.charCodeAt().toString(<span class="number">16</span>), <span class="number">2</span>)
  }).join(<span class="string">''</span>);
  my.cc1_r = <span class="keyword">new</span> RegExp(<span class="string">'['</span> + acc + <span class="string">']'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <h3>ESC</h3>
<p>Collection of control two-byte and three-byte sequences 
starting with ESC.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.ESC = {</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Index (IND)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'D'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_line_feed'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Next Line (NEL)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'E'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_cursor_column'</span>, <span class="number">0</span>)
      that.emit(<span class="string">'term_cursor_down'</span>, <span class="number">1</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Horizontal Tabulation Set (HTS)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'H'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_set_tab_stop_current'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Reverse Index (RI)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'M'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_reverse_line_feed'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Single Shift 2 (SS2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'N'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Single Shift 3 (SS3)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'O'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Device Control String (DCS)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'P'</span>: <span class="keyword">function</span>() {
      my.parse_state.reset_args();
      my.parse_state.set_fun(parse_until_string_terminator);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Start of Pretected Area (SPA)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'V'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>End of Protected Area (EPA)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'W'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Start of String (SOS)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'X'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Single Character Introducer (SCI, also DECID)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'Z'</span>: <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>TODO: implement this one
this.terminal.io.sendString(&#39;\x1b[?1;2c&#39;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    },</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Control Sequence Introducer (CSI)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'['</span>: <span class="keyword">function</span>() {
      my.parse_state.reset_args();
      my.leading_modifer = <span class="string">''</span>;
      my.Trailing_modifier = <span class="string">''</span>;
      my.parse_state.set_fun(parse_csi);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>String Terminator (ST)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\\'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Operating System Command (OSC)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">']'</span>: <span class="keyword">function</span>() {
      my.parse_state.reset_args();
      <span class="function"><span class="keyword">function</span> <span class="title">parse_osc</span><span class="params">()</span> {</span>
        <span class="keyword">if</span>(!parse_until_string_terminator()) {
          <span class="comment">/* The string was too long or invalid */</span>
          <span class="keyword">return</span>;
        }
        <span class="keyword">else</span> <span class="keyword">if</span>(my.parse_state.fun() === parse_osc) {
          <span class="comment">/* We're not done parsing the string yet */</span>
          <span class="keyword">return</span>;
        }
        <span class="keyword">else</span> {
          <span class="comment">/* We're done */</span>
          <span class="keyword">var</span> ary_r = <span class="regexp">/^(\d+);(.*)$/</span>;
          <span class="keyword">var</span> ary_m = my.parse_state.args()[<span class="number">0</span>].match(ary_r);
          <span class="keyword">if</span>(ary_m) {
            my.parse_state.args()[<span class="number">0</span>] = ary_m[<span class="number">2</span>];
            dispatch(<span class="string">'OSC'</span>, ary[<span class="number">1</span>]);
          }
          <span class="keyword">else</span> {
            console.log(<span class="string">'Invalid OSC: '</span> + my.parse_state.args()[<span class="number">0</span>]);
          }
        }
      };
      my.parse_state.set_fun(parse_osc);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Privacy Message (PM)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'^'</span>: <span class="keyword">function</span>() {
      my.parse_state.reset_args();
      my.parse_state.set_fun(parse_until_string_terminator);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Application Program Control (APC)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'_'</span>: <span class="keyword">function</span>() {
      my.parse_state.reset_args();
      my.parse_state.set_fun(parse_until_string_terminator);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>xterm &#39;ESC 0x20&#39; Sequence</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'\x20'</span>: <span class="keyword">function</span>() {
      <span class="keyword">var</span> parse = <span class="keyword">function</span>() {
        <span class="keyword">var</span> ch = my.parse_state.consume();
        <span class="keyword">if</span>(my.warn) {
          console.log(<span class="string">'Unimplemented Sequence: ESC 0x20 '</span> + ch);
        }
        my.parse_state.reset_fun();
      };
      my.parse_state.set_fun(parse);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>DEC &#39;ESC #&#39; Sequences</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'#'</span>: <span class="keyword">function</span>() {
      <span class="keyword">var</span> parse = <span class="keyword">function</span>() {
        <span class="keyword">var</span> ch = my.parse_state.consume();
        <span class="keyword">if</span>(ch === <span class="string">'8'</span>) {
          that.emit(<span class="string">'term_fill'</span>, <span class="string">'E'</span>);
        }
        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">'3456'</span>.indexOf(ch) === -<span class="number">1</span>) {
          <span class="comment">/* Echo to terminal all non reserved sequences */</span>
          that.emit(<span class="string">'term_print'</span>, <span class="string">'\x1b#'</span> + ch);
        }
        my.parse_state.reset_fun();
      };
      my.parse_state.set_fun(parse);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>&#39;ESC %&#39; Sequences</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'%'</span>: <span class="keyword">function</span>() {
      <span class="keyword">var</span> parse = <span class="keyword">function</span>() {
        <span class="keyword">var</span> ch = my.parse_state.consume();
        <span class="keyword">if</span> (my.warn) {
          console.log(<span class="string">'Unknown/Unimplemented Seuqnce : ESC % '</span> + ch);
        }
        my.parse_state.reset_fun();
      };
      my.parse_state.set_fun(parse);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Back Index (DECBI)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'6'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Sace Cursor (DECSC)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'7'</span>: <span class="keyword">function</span>() {
      my.saved_state.save();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Restore Cursor (DECRC)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'8'</span>: <span class="keyword">function</span>() {
      my.saved_state.restore();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Application Keypad (DECPAM)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'='</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_application_keypad'</span>, <span class="literal">true</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Normal Keypad (DECPNM)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'&gt;'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_application_keypad'</span>, <span class="literal">false</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Cursor to Lower Left (xterm only)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'F'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Full Reset (RIS)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'c'</span>: <span class="keyword">function</span>() {
      reset()
      that.emit(<span class="string">'term_reset'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Memory Lock / Unlock</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'l'</span>: ignore,
    <span class="string">'m'</span>: ignore,</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Lock Shift 2 (LS2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'n'</span>: <span class="keyword">function</span>() {
      my.GL = <span class="string">'G2'</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Lock Shift 3 (LS3)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'o'</span>: <span class="keyword">function</span>() {
      my.GL = <span class="string">'G3'</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Lock Shift 3, Right (LS3R)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'l'</span>: <span class="keyword">function</span>() {
      my.GR = <span class="string">'G3'</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Lock Shift 2, Right (LS2R)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'}'</span>: <span class="keyword">function</span>() {
      my.GR = <span class="string">'G1'</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Lock Shift 1, Right (LS1R)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'~'</span>: <span class="keyword">function</span>() {
      my.GR = <span class="string">'G1'</span>;
    },
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Character Set Selection (SCS) </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.ESC[<span class="string">'('</span>] =
  my.ESC[<span class="string">')'</span>] =
  my.ESC[<span class="string">'*'</span>] =
  my.ESC[<span class="string">'+'</span>] =
  my.ESC[<span class="string">'-'</span>] =
  my.ESC[<span class="string">'.'</span>] =
  my.ESC[<span class="string">'/'</span>] = <span class="keyword">function</span>(code) {
    <span class="keyword">var</span> parse = <span class="keyword">function</span>() {
      <span class="keyword">var</span> ch = my.parse_state.consume();
      <span class="keyword">if</span>(ch === <span class="string">'\x1b'</span>) {
        my.parse_state.reset_fun();
        my.parse_state.fun()();
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span>(ch <span class="keyword">in</span> require(<span class="string">'./char_map.js'</span>).maps) {
        <span class="keyword">if</span>(code === <span class="string">'('</span>) {
          my.G0 = require(<span class="string">'./char_map.js'</span>).maps[ch];
        }
        <span class="keyword">else</span> <span class="keyword">if</span>(code ===<span class="string">')'</span> || code === <span class="string">'-'</span>) {
          my.G1 = require(<span class="string">'./char_map.js'</span>).maps[ch];
        }
        <span class="keyword">else</span> <span class="keyword">if</span>(code ===<span class="string">'*'</span> || code === <span class="string">'.'</span>) {
          my.G2 = require(<span class="string">'./char_map.js'</span>).maps[ch];
        }
        <span class="keyword">else</span> <span class="keyword">if</span>(code ===<span class="string">'+'</span> || code === <span class="string">'/'</span>) {
          my.G3 = require(<span class="string">'./char_map.js'</span>).maps[ch];
        }
      }
      <span class="keyword">else</span> <span class="keyword">if</span>(my.warn) {
        console.log(<span class="string">'Invalid Character Set: '</span> + ch + <span class="string">' for code: '</span> + code);
      }
      my.parse_state.reset_fun();
    };
    my.parse_state.set_fun(parse);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <h3>OSC</h3>
<p>Colleciton of OSC (Operating System Control) sequences.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.OSC = {</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Change Icon Name and Window Title</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'0'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_window_title'</span>, my.parse_state.args()[<span class="number">0</span>]);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Change Window Title</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'2'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_window_title'</span>, my.parse_state.args()[<span class="number">0</span>]);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Set/Read Color Palette</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'4'</span>: <span class="keyword">function</span>() {
      <span class="comment">/* Args Format: 'index1;rgb1 ... ;indexN;rgbN' */</span>
      <span class="keyword">var</span> args = my.parse_state.args[<span class="number">0</span>].split(<span class="string">';'</span>);
      
      <span class="keyword">var</span> n = Math.floor(args.length / <span class="number">2</span>);
      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; n; i++) {
        <span class="keyword">var</span> idx = parseInt(args[i*<span class="number">2</span>], <span class="number">10</span>);
        <span class="keyword">var</span> val = args[i*<span class="number">2</span>+<span class="number">1</span>];
        <span class="keyword">if</span>(val === <span class="string">'?'</span>) {
          <span class="keyword">if</span>(my.warn) {
            console.log(<span class="string">'Unimplemented OSC Color Palette Read'</span>);
          }
          conitnue;
        }
        val = require(<span class="string">'./colors.js'</span>).x11_to_css(val);
        <span class="keyword">if</span>(val) {
          that.emit(<span class="string">'term_color_palette'</span>, idx, val);
        }
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Set/Read System Clipboard</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'52'</span>: <span class="keyword">function</span>() {
      <span class="keyword">var</span> args_r = <span class="regexp">/^[cps01234567]+;(.*)$/</span>;
      <span class="keyword">var</span> args_m = my.parse_state.args()[<span class="number">0</span>].match(args_r);
      <span class="keyword">if</span>(!args_m)
        <span class="keyword">return</span>;
      <span class="keyword">var</span> data = <span class="keyword">new</span> Buffer(args_m[<span class="number">1</span>], <span class="string">'base64'</span>).toString(<span class="string">'utf8'</span>) 
      <span class="keyword">if</span>(data &amp;&amp; data.length &gt; <span class="number">0</span>)
        that.emit(<span class="string">'term_copy_to_clipboard'</span>, data);
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <h3>CSI</h3>
<p>Collection of CSI (Control Sequence Introducer) sequences.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.CSI = {</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Insert (blank) characters (ICH)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'@'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_insert_space'</span>, my.parse_state.int_arg(<span class="number">0</span>, <span class="number">1</span>));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Cursor Up (CUU)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">'A'</span>: <span class="keyword">function</span>() {
      that.emit(<span class="string">'term_cursor_up'</span>, my.parse_state.int_arg(<span class="number">0</span>, <span class="number">1</span>));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  };</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <h3>VT52 sequences</h3>
<p>Collection of VT52 sequences.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.VT52 = {</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  };</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <h3>Initialization</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset();

  fwk.getter(that, <span class="string">'G0'</span>, my, <span class="string">'G0'</span>);
  fwk.setter(that, <span class="string">'G0'</span>, my, <span class="string">'G0'</span>);
  fwk.getter(that, <span class="string">'G1'</span>, my, <span class="string">'G1'</span>);
  fwk.setter(that, <span class="string">'G1'</span>, my, <span class="string">'G1'</span>);
  fwk.getter(that, <span class="string">'G2'</span>, my, <span class="string">'G2'</span>);
  fwk.setter(that, <span class="string">'G2'</span>, my, <span class="string">'G2'</span>);
  fwk.getter(that, <span class="string">'G3'</span>, my, <span class="string">'G3'</span>);
  fwk.setter(that, <span class="string">'G3'</span>, my, <span class="string">'G3'</span>);

  fwk.getter(that, <span class="string">'GR'</span>, my, <span class="string">'GR'</span>);
  fwk.setter(that, <span class="string">'GR'</span>, my, <span class="string">'GR'</span>);
  fwk.getter(that, <span class="string">'GL'</span>, my, <span class="string">'GL'</span>);
  fwk.setter(that, <span class="string">'GL'</span>, my, <span class="string">'GL'</span>);

  <span class="keyword">return</span> that;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
