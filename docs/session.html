<!DOCTYPE html>

<html>
<head>
  <title>session.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="colors_s.html">
                colors_s.js
              </a>
            
              
              <a class="source" href="keymap_f.html">
                keymap_f.js
              </a>
            
              
              <a class="source" href="session_s.html">
                session_s.js
              </a>
            
              
              <a class="source" href="stack_d.html">
                stack_d.js
              </a>
            
              
              <a class="source" href="term_d.html">
                term_d.js
              </a>
            
              
              <a class="source" href="char_map.html">
                char_map.js
              </a>
            
              
              <a class="source" href="common.html">
                common.js
              </a>
            
              
              <a class="source" href="session.html">
                session.js
              </a>
            
              
              <a class="source" href="term.html">
                term.js
              </a>
            
              
              <a class="source" href="vt.html">
                vt.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>session.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*
 * breach: session.js
 *
 * Copyright (c) 2013, Stanislas Polu. All rights reserved.
 * (see LICENSE file)
 *
 * @log
 * - 20130517 @spolu    Cursor data forwarding
 * - 20130501 @spolu    API Change (no stack, term dictionary)
 * - 20130430 @spolu    Added cols/rows to spec
 * - 20130429 @spolu    Base implementation and event emission
 * - 20130414 @spolu    Basic architecture and documentation
 */</span>
<span class="keyword">var</span> common = require(<span class="string">'./common.js'</span>);
<span class="keyword">var</span> util = require(<span class="string">'util'</span>);
<span class="keyword">var</span> events = require(<span class="string">'events'</span>);
<span class="keyword">var</span> uuid = require(<span class="string">'node-uuid'</span>);
<span class="keyword">var</span> factory = common.factory({ debug: <span class="literal">false</span> });

<span class="string">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Session</h2>
<p>The <code>session</code> object is in charge of keeping track of the opened terms. It 
also creates the ptys when spawning a new term. It exposes an API to receive 
keyboard input. It also triggers the resizing of the terminals when needed.</p>
<p>The navigation or organization of the terminals is left to the client. A
session really just is a dictionary of opened terminals</p>
<p>/!\ Buffer and buffer slices are passed as is without being deeply cloned to
    gain performance</p>
<p>TODO: 
- Move to a file based storage of the current session
- PAM integration</p>
<pre><code>@inherits events.EventEmitter
@param spec {}

@emits `refresh`   [id, dirty, slice, cursor]
@emits `alternate` [is_alt, buffer]
@emits `title`     [id, title]

@emits `spawn`     [id, term]
@emits `resize`    [id, cols, rows]
@emits `write`     [id, data]</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> session = <span class="keyword">function</span>(spec, my) {
  <span class="keyword">var</span> _super = {};
  my = my || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h4><em>private members</em></h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.terms = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4><em>public methods</em></h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> spawn;     <span class="comment">/* spawn(cols, rows); */</span>
  <span class="keyword">var</span> term;      <span class="comment">/* term(id); */</span>
  <span class="keyword">var</span> term_mode; <span class="comment">/* term_mode(id); */</span>
  <span class="keyword">var</span> resize;    <span class="comment">/* resize(id, cols, rows); */</span>
  <span class="keyword">var</span> write;     <span class="comment">/* write(id, data); */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4><em>that</em></h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> that = <span class="keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>spawn</h3>
<pre><code>@cols {number} initial cols number
@rows {number} initial rows number</code></pre>
<p>Spawns a <code>bash</code> shell within a new <code>pty</code>, pass it to a new <code>term</code> object
constructor and push that <code>term</code> on the list of terms.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  spawn = <span class="keyword">function</span>(cols, rows) {
    <span class="keyword">var</span> pty = require(<span class="string">'pty.js'</span>).spawn(<span class="string">'bash'</span>, [], {
      name: <span class="string">'xterm'</span>,
      cols: cols || <span class="number">80</span>,
      rows: rows || <span class="number">24</span>,
      cwd: process.env.HOME,
      env: process.env
    });

    <span class="keyword">var</span> term = require(<span class="string">'./term.js'</span>).term({ 
      pty: pty,
      cols: cols || <span class="number">80</span>,
      rows: rows || <span class="number">24</span>
    });

    <span class="keyword">var</span> id = uuid.v4();

    term.on(<span class="string">'resize'</span>, <span class="keyword">function</span>(cols, rows) {
      pty.resize(cols, rows);
    });
    term.on(<span class="string">'refresh'</span>, <span class="keyword">function</span>(dirty, slice, cursor) {
      that.emit(<span class="string">'refresh'</span>, id, dirty, slice, cursor);
    });
    term.on(<span class="string">'alternate'</span>, <span class="keyword">function</span>(is_alt) {
      that.emit(<span class="string">'alternate'</span>, id, is_alt, that.term(id).buffer);
    });
    term.on(<span class="string">'title'</span>, <span class="keyword">function</span>(title) {
      that.emit(<span class="string">'title'</span>, id, title);
    });

    my.terms[id] = term;
    that.emit(<span class="string">'spawn'</span>, id, that.term(id));

    <span class="keyword">return</span> id;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>term</h3>
<pre><code>@id   {string} the terminal id</code></pre>
<p>Dumps an object representation of the terminal designated by id or the
whole session if no index is specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  term = <span class="keyword">function</span>(id) {
    <span class="keyword">if</span>(<span class="keyword">typeof</span> id === <span class="string">'string'</span> &amp;&amp; my.terms[id]) {
      <span class="keyword">return</span> {
        id: id,
        title: my.terms[id].title(),
        mode: my.terms[id].mode(),
        buffer: my.terms[id].buffer(),
        cursor: my.terms[id].cursor()
      }
    }
    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> id === <span class="string">'undefined'</span>) {
      <span class="keyword">var</span> session = { terms: {} };
      <span class="keyword">for</span>(id <span class="keyword">in</span> my.terms) {
        session.terms[id] = term(id);
      }
      <span class="keyword">return</span> session;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>term_mode</h3>
<pre><code>@id   {string} the terminal id</code></pre>
<p>Returns the mode for the terminal designated by id. The mode is a bitwise
representation of the current terminal mode (see term.js)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  term_mode = <span class="keyword">function</span>(id) {
    <span class="keyword">if</span>(<span class="keyword">typeof</span> id === <span class="string">'string'</span> &amp;&amp; my.terms[id]) {
      <span class="keyword">return</span> my.terms[id].mode();
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3>resize</h3>
<pre><code>@id   {string} the terminal id or null for all terminals
@cols {number} the number of cols
@rows {number} the number of rows</code></pre>
<p>Informs the session that the window size has changed. This will be 
forwarded to the underlying terminals.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resize = <span class="keyword">function</span>(id, cols, rows) {
    <span class="keyword">if</span>(id) {
      <span class="keyword">if</span>(my.terms[id]) {
        my.terms[id].resize(cols, rows);
        that.emit(<span class="string">'resize'</span>, id, cols, rows);
      }
    }
    <span class="keyword">else</span> {
      <span class="keyword">for</span>(id <span class="keyword">in</span> my.terms) {
        resize(id, cols, rows);
      }
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3>write</h3>
<pre><code>@id   {string} the terminal id or null for all terminals
@data {buffer} the data to write to the active term&#39;s underlying pty socket</code></pre>
<p>Writes received data into the current term.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  write = <span class="keyword">function</span>(id, data) {
    <span class="keyword">if</span>(my.terms[id]) {
      my.terms[id].pty().write(data);
      that.emit(<span class="string">'write'</span>, id, data);
    }
  };


  common.method(that, <span class="string">'spawn'</span>, spawn, _super);
  common.method(that, <span class="string">'term'</span>, term, _super);
  common.method(that, <span class="string">'term_mode'</span>, term_mode, _super);
  common.method(that, <span class="string">'resize'</span>, resize, _super);
  common.method(that, <span class="string">'write'</span>, write, _super);

  <span class="keyword">return</span> that;
};

exports.session = session;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
