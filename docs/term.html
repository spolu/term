<!DOCTYPE html>

<html>
<head>
  <title>term.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="colors_s.html">
                colors_s.js
              </a>
            
              
              <a class="source" href="keymap_f.html">
                keymap_f.js
              </a>
            
              
              <a class="source" href="session_s.html">
                session_s.js
              </a>
            
              
              <a class="source" href="stack_d.html">
                stack_d.js
              </a>
            
              
              <a class="source" href="term_d.html">
                term_d.js
              </a>
            
              
              <a class="source" href="char_map.html">
                char_map.js
              </a>
            
              
              <a class="source" href="common.html">
                common.js
              </a>
            
              
              <a class="source" href="session.html">
                session.js
              </a>
            
              
              <a class="source" href="term.html">
                term.js
              </a>
            
              
              <a class="source" href="vt.html">
                vt.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>term.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*
 * breach: term.js
 *
 * Copyright (c) 2013, Stanislas Polu. All rights reserved.
 * (see LICENSE file)
 *
 * @log
 * - 20130517 @spolu    Expose the cursor
 * - 20130514 @spolu    Fixes to properly run vim
 * - 20130510 @spolu    Fixes first time running vim
 * - 20130502 @spolu    Fixed dirty computation (esp. in case of resizing)
 * - 20130430 @spolu    Added cols / rows to term spec
 * - 20130429 @spolu    First implementation done. 
 *                      Color optimization &amp; `my.scroll`
 * - 20130415 @spolu    Comments and basic architecture
 */</span>
<span class="string">'use strict'</span>;

<span class="keyword">var</span> common = require(<span class="string">'./common.js'</span>);
<span class="keyword">var</span> events = require(<span class="string">'events'</span>);
<span class="keyword">var</span> util = require(<span class="string">'util'</span>);
<span class="keyword">var</span> pty = require(<span class="string">'pty.js'</span>);
<span class="keyword">var</span> factory = common.factory({ debug: <span class="literal">false</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>CHAR_ATTRS</h2>
<p>Bitwise values for character attribute. Each glyph in the term is a couple
<code>[attr, c]</code> with c being a utf8 character and attr a 32 bit integer with:
Next 9 bits: Backround Color (0-511)
Next 9 bits: Foreground Color (0-511)
Next 14 bits: Mask of CHAR_ATTRS bitwise encoded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> CHAR_ATTRS = {
  NULL: <span class="number">0</span>,
  REVERSE: <span class="number">1</span>,
  UNDERLINE: <span class="number">2</span>,
  BOLD: <span class="number">4</span>,
  GFX: <span class="number">8</span>,
  ITALIC: <span class="number">16</span>,
  BLINK: <span class="number">32</span>
};

<span class="keyword">var</span> CURSOR_STATE = { 
  DEFAULT: <span class="number">0</span>,
  WRAPNEXT: <span class="number">1</span>,
  ORIGIN: <span class="number">2</span>
};
    
<span class="keyword">var</span> TERM_MODE = {
  WRAP: <span class="number">1</span>,
  INSERT: <span class="number">2</span>,
  APPKEYPAD: <span class="number">4</span>,
  ALTSCREEN: <span class="number">8</span>,
  CRLF: <span class="number">16</span>,
  MOUSEBTN: <span class="number">32</span>,
  MOUSEMOTION: <span class="number">64</span>,
  MOUSE: <span class="number">32</span>|<span class="number">64</span>,
  REVERSE: <span class="number">128</span>,
  KBDLOCK: <span class="number">256</span>,
  HIDE: <span class="number">512</span>,
  ECHO: <span class="number">1024</span>,
  APPCURSOR: <span class="number">2048</span>,
  MOUSESGR: <span class="number">4096</span>,
};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2>Term</h2>
<p>Represents the state of an emulated temrinal</p>
<p>The <code>term</code> object is in charge of emulating the data received from the <em>tty</em>
and compute the current state of the terminal (with help of vt.js)</p>
<p>It also keeps track of the entire scrollback history composed of lines of
glyphs. </p>
<p>Glyphs are tuples of the type: <code>[[CHAR_ATTR, fg_color, bg_color], char]</code></p>
<pre><code>@inherits events.EventEmitter
@param spec { pty, cols, rows }

@emits `refresh`   [dirty, slice, cursor]
@emits `alternate` [is_alt]
@emits `title`     [title]

@emits `resize`    [cols, rows]</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> term = <span class="keyword">function</span>(spec, my) {
  <span class="keyword">var</span> _super = {};
  my = my || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4><em>private members</em></h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.geometry = [spec.cols || <span class="number">0</span>, spec.rows || <span class="number">0</span>];  <span class="comment">/* [cols, rows] */</span>
  my.pty = spec.pty;
  my.vt = require(<span class="string">'./vt.js'</span>).vt({});

  <span class="comment">/* See `reset` for the initialization of the private variables relative */</span>
  <span class="comment">/* to the terminal state.                                               */</span>

  my.saved_cursor = <span class="literal">null</span>;
  my.saved_screen = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4><em>public methods</em></h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> resize;         <span class="comment">/* resize(cols, rows, silent); */</span>
  <span class="keyword">var</span> cursor;         <span class="comment">/* cursor(); */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h4><em>private methods</em></h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> IS_SET;         <span class="comment">/* IS_SET(x, bit); */</span>
  <span class="keyword">var</span> SET;            <span class="comment">/* SET(x, bit); */</span>
  <span class="keyword">var</span> UNSET;          <span class="comment">/* UNSET(x, bit); */</span>

  <span class="keyword">var</span> init;           <span class="comment">/* init(); */</span>
  <span class="keyword">var</span> glyph;          <span class="comment">/* glyph(char); */</span>
  <span class="keyword">var</span> reset;          <span class="comment">/* reset(); */</span>
  <span class="keyword">var</span> save_cursor;    <span class="comment">/* save_cursor() */</span>
  <span class="keyword">var</span> restore_cursor; <span class="comment">/* restore_cursor() */</span>
  <span class="keyword">var</span> soft_reset;     <span class="comment">/* soft_reset(); */</span>
  <span class="keyword">var</span> move_to;        <span class="comment">/* move_to(x,y); */</span>
  <span class="keyword">var</span> new_line;       <span class="comment">/* new_line([first_col]); */</span>
  <span class="keyword">var</span> setup_stops;    <span class="comment">/* setup_stops(); */</span>
  <span class="keyword">var</span> next_stop;      <span class="comment">/* next_stop(); */</span>
  <span class="keyword">var</span> prev_stop;      <span class="comment">/* prev_stop(); */</span>
  <span class="keyword">var</span> dirty;          <span class="comment">/* dirty(y); */</span>
  <span class="keyword">var</span> clear_region;   <span class="comment">/* clear_region(x, y, cols, rows, char_value); */</span>
  <span class="keyword">var</span> delete_chars;   <span class="comment">/* delete_chars(n); */</span>
  <span class="keyword">var</span> insert_chars;   <span class="comment">/* insert_chars(n); */</span>

  <span class="keyword">var</span> blank_line;     <span class="comment">/* blank_line(); */</span>
  <span class="keyword">var</span> scroll;         <span class="comment">/* scroll(n); */</span>
  <span class="keyword">var</span> put_char;       <span class="comment">/* put_char(c); */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><em>that</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> that = <span class="keyword">new</span> events.EventEmitter();

  <span class="comment">/****************************************************************************/</span>
  <span class="comment">/*                          PRIVATE FUNCTIONS                               */</span>
  <span class="comment">/****************************************************************************/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>IS_SET</h3>
<pre><code>@ x  {number} variable
@bit {number} checks if the `bit` is currently set in `mode`</code></pre>
<p>Helper function to check if a mode bit is set (bitwise operations)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  IS_SET = <span class="keyword">function</span>(x, bit) {
    <span class="keyword">return</span> ((x &amp; bit) != <span class="number">0</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3>SET</h3>
<pre><code>@x   {number} mode variable
@bit {number} mode bit to set</code></pre>
<p>Helper function to set a mode bit (bitwise operations)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  SET = <span class="keyword">function</span>(x, bit) {
    <span class="keyword">return</span> x | bit;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3>UNSET</h3>
<pre><code>@x   {number} mode variable
@bit {number} mode bit to unset</code></pre>
<p>Helper function to unset a mode bit (bitwise operations)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  UNSET = <span class="keyword">function</span>(x, bit) {
    <span class="keyword">return</span> x &amp; ~bit;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3>glyph</h3>
<pre><code>@char {string} character to build the glyph from [optional, default: &#39; &#39;]
@attr {number} override char attribute [optional]</code></pre>
<p>Builds a new glyph with the current cursor character attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  glyph = <span class="keyword">function</span>(char, attr) {
    <span class="keyword">return</span> [
      (<span class="keyword">typeof</span> attr !== <span class="string">'undefined'</span>) ? attr : my.cursor.attr,
      (<span class="keyword">typeof</span> char !== <span class="string">'undefined'</span>) ? char : <span class="string">' '</span>
    ];
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3>reset</h3>
<p>Resets the terminal. Clears everything and refills the buffer with empty
data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset = <span class="keyword">function</span>() {
    my.mode = TERM_MODE.WRAP;
    my.cursor = {
      attr: <span class="number">256</span> | (<span class="number">257</span> &lt;<span class="xml"><span class="tag">&lt; <span class="attribute">9</span>) | (<span class="attribute">CHAR_ATTRS.NULL</span> &lt;&lt; <span class="attribute">18</span>),
      <span class="attribute">x:</span> <span class="attribute">0</span>,
      <span class="attribute">y:</span> <span class="attribute">0</span>,
      <span class="attribute">state:</span> <span class="attribute">CURSOR_STATE.DEFAULT</span>
    };
    <span class="attribute">my.tabs</span> = {};
    <span class="attribute">my.buffer</span> = [];
    <span class="attribute">my.title</span> = <span class="attribute">null</span>;

    <span class="attribute">my.base</span> = <span class="attribute">0</span>;
    <span class="attribute">my.scroll</span> = {
      <span class="attribute">top:</span> <span class="attribute">0</span>,
      <span class="attribute">bottom:</span> <span class="attribute">my.geometry</span>[<span class="attribute">1</span>] <span class="attribute">-</span> <span class="attribute">1</span>
    };

    <span class="attribute">my.dirty</span> = [];

    /* <span class="attribute">Resize</span> <span class="attribute">to</span> <span class="attribute">fill</span> <span class="attribute">buffer</span> &amp; <span class="attribute">setup</span> <span class="attribute">stops</span> */
    <span class="attribute">resize</span>(<span class="attribute">my.geometry</span>[<span class="attribute">0</span>], <span class="attribute">my.geometry</span>[<span class="attribute">1</span>], <span class="attribute">true</span>);
  };

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3>soft_reset</h3>
<p>Soft resets the terminal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  soft_reset = <span class="keyword">function</span>() {
    my.mode = TERM_MODE.WRAP;
    <span class="comment">/* Reset scroll region */</span>
    my.scroll = {
      top: <span class="number">0</span>,
      bottom: my.geometry[<span class="number">1</span>] - <span class="number">1</span>
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3>save_cursor</h3>
<p>Saves the current cursor state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  save_cursor = <span class="keyword">function</span>() {
    my.saved_cursor = my.cursor;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3>restore_cursor</h3>
<p>Restores the saved cursor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  restore_cursor = <span class="keyword">function</span>() {
    my.cursor = my.saved_cursor;
    move_to(my.cursor.x, my.cursor.y);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3>setup_stops</h3>
<pre><code>@pos {number} position from which to set tabs [optional]</code></pre>
<p>Setups tabs stop object given the current geometry. If <code>pos</code> is not defined
then tabs are reset entirely.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setup_stops = <span class="keyword">function</span>(pos) {
    <span class="keyword">var</span> i = <span class="number">0</span>;
    <span class="keyword">if</span>(<span class="keyword">typeof</span> pos !== <span class="string">'number'</span>) {
      my.tabs = {};
    }
    <span class="keyword">else</span> {
      i = prev_stop(Math.round(pos));
    }
    <span class="keyword">for</span>(; i &lt; my.geometry[<span class="number">0</span>]; i += <span class="number">8</span>) {
      my.tabs[i] = <span class="literal">true</span>;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3>prev_stop</h3>
<pre><code>@x {number} position from which to jump [optional]</code></pre>
<p>Jumps to the previous tab_stops from x. If x is not specified then 
<code>my.cursor.x</code> is  used instead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  prev_stop = <span class="keyword">function</span>(x) {
    <span class="keyword">if</span>(<span class="keyword">typeof</span> x !== <span class="string">'number'</span>) x = my.cursor.x;
    <span class="keyword">while</span>(!my.tabs[--x] &amp;&amp; x &gt; <span class="number">0</span>);
    x = common.clamp(x, <span class="number">0</span>, my.geometry[<span class="number">0</span>]-<span class="number">1</span>);
    <span class="keyword">return</span> x;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3>next_stop</h3>
<pre><code>@x {number} position from which to jump [optional]</code></pre>
<p>Jumps to the next tab_stops from x. If x is not specified then 
<code>my.cursor.x</code> is used instead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  next_stop = <span class="keyword">function</span>(x) {
    <span class="keyword">if</span>(<span class="keyword">typeof</span> x !== <span class="string">'number'</span>) x = my.cursor.x;
    <span class="keyword">while</span>(!my.tabs[++x] &amp;&amp; x &lt; my.geometry[<span class="number">0</span>]);
    x = common.clamp(x, <span class="number">0</span>, my.geometry[<span class="number">0</span>]-<span class="number">1</span>);
    <span class="keyword">return</span> x;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3>dirty</h3>
<pre><code>@y {number} extend dirtiness to buffer line</code></pre>
<p>Make the specified buffer line dirty. We&#39;re in <code>buffer</code> line number 
referential (not visible screen).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dirty = <span class="keyword">function</span>(y) {
    <span class="keyword">if</span>(my.dirty.length === <span class="number">0</span>) {
      my.dirty = [y, y];
    }
    <span class="keyword">else</span> { 
      <span class="keyword">if</span>(my.dirty[<span class="number">0</span>] &gt; y) my.dirty[<span class="number">0</span>] = y;
      <span class="keyword">if</span>(my.dirty[<span class="number">1</span>] &lt; y) my.dirty[<span class="number">1</span>] = y;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h3>blank_line</h3>
<p>Generates a blank new line to be appended to the lines array when a new 
line needs to be created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  blank_line = <span class="keyword">function</span>() {
    <span class="keyword">var</span> g = glyph();
    <span class="keyword">var</span> line = [];
    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; my.geometry[<span class="number">0</span>]; i ++) {
      line[i] = g;
    }
    <span class="keyword">return</span> line;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h3>scroll</h3>
<pre><code>@n {number} number of lines to scroll</code></pre>
<p>Scrolls <code>n</code> lines. If <code>n&gt;0</code>, it scrolls up, otherwise scrolls down. 
(<code>scroll(0)</code> has no effect)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  scroll = <span class="keyword">function</span>(n) {
    <span class="keyword">if</span>(n &gt;= <span class="number">0</span>) {
      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; n; i ++) {
        <span class="keyword">var</span> row = ++my.base + my.scroll.bottom;
        my.buffer.splice(row, <span class="number">0</span>, blank_line());
      }
      <span class="comment">/* TODO: handle my.scroll.top if needed              */</span>
      <span class="comment">/* if(my.scroll.top !== 0) {                         */</span>
      <span class="comment">/*   if(my.base &gt; 0) my.base--;                      */</span>
      <span class="comment">/*   my.buffer.splice(my.base + my.scroll.top, 1);   */</span>
      <span class="comment">/* }                                                 */</span>
    }
    <span class="keyword">else</span> {
      <span class="keyword">var</span> n = -n;
      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; n; i ++) {
        my.buffer.splice(my.base + my.scroll.bottom, <span class="number">1</span>);
        my.buffer.splice(my.base + my.scroll.top, <span class="number">0</span>, blank_line());
      }
    }
    dirty(my.base + my.scroll.bottom - n);
    dirty(my.base + my.scroll.bottom);
    <span class="comment">/* TODO: selscroll? */</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h3>move_to</h3>
<pre><code>@x        {number} cols position
@y        {number} rows position
@absolute {boolean} move with scroll region</code></pre>
<p>Moves to the specified position clamping it if necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  move_to = <span class="keyword">function</span>(x, y, absolute) {
    factory.log().debug(<span class="string">'move_to: '</span> + x + <span class="string">' '</span> + y + <span class="string">' '</span> + absolute);
    <span class="keyword">var</span> miny = <span class="number">0</span>;
    <span class="keyword">var</span> maxy = my.geometry[<span class="number">1</span>] - <span class="number">1</span>;
    <span class="keyword">if</span>(IS_SET(my.cursor.state, CURSOR_STATE.ORIGIN)) {
      miny = my.scroll.top;
      maxy = my.scroll.bottom;
      <span class="keyword">if</span>(!absolute) y += my.scroll.top;
    }
    my.cursor.state = UNSET(my.cursor.state, CURSOR_STATE.WRAPNEXT);
    dirty(my.base + my.cursor.y);
    my.cursor.x = common.clamp(x, <span class="number">0</span>, my.geometry[<span class="number">0</span>]);
    my.cursor.y = common.clamp(y, miny, maxy);
    dirty(my.base + my.cursor.y);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h3>new_line</h3>
<pre><code>@first_col {boolean} moves to first column</code></pre>
<p>Moves one line down (and first_col if specified) and scrolls if needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  new_line = <span class="keyword">function</span>(first_col) {
    <span class="keyword">var</span> y = my.cursor.y;
    <span class="keyword">if</span>(my.cursor.y &gt;= my.scroll.bottom) {
      scroll(<span class="number">1</span>);
    }
    <span class="keyword">else</span> {
      y += <span class="number">1</span>;
    }
    move_to(first_col ? <span class="number">0</span> : my.cursor.x, y);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h3>put_char</h3>
<pre><code>@c {string} charchter to put</code></pre>
<p>Puts a single char taking care of wrapping</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  put_char = <span class="keyword">function</span>(c) {
    <span class="keyword">if</span>(IS_SET(my.mode, TERM_MODE.WRAP) &amp;&amp; 
       (my.cursor.state &amp; CURSOR_STATE.WRAPNEXT)) {
      new_line(<span class="literal">true</span>);
    }
    <span class="keyword">if</span>(IS_SET(my.mode, TERM_MODE.INSERT) &amp;&amp; 
       my.cursor.x + <span class="number">1</span> &lt; my.geometry[<span class="number">0</span>]) {
      my.buffer[my.base + my.cursor.y].splice(my.cursor.x, <span class="number">0</span>, [glyph()]);
    }
    my.buffer[my.base + my.cursor.y][my.cursor.x] = glyph(c);
    <span class="keyword">if</span>(my.cursor.x + <span class="number">1</span> &lt; my.geometry[<span class="number">0</span>]) {
      move_to(my.cursor.x + <span class="number">1</span>, my.cursor.y);
    }
    <span class="keyword">else</span> {
      my.cursor.state = SET(my.cursor.state, CURSOR_STATE.WRAPNEXT);
    }
    dirty(my.base + my.cursor.y);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h3>clear_region</h3>
<pre><code>@x {number} cols origin of region to clear [optional]
@y {number} rows origin of region to clear [optional]
@cols {number} number of columns to clear [optional]
@rows {number} number of rows to clear [optional]
@char_value {string} default char value to clear with [optional]</code></pre>
<p>Clears the region by resetting all glyphes to <code>char_value</code> if defined. It
clears the screen region independently of scroll region. If no parameter is
specified, it clears the entire screen;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clear_region = <span class="keyword">function</span>(x, y, cols, rows, char_value) {
    x = (<span class="keyword">typeof</span> x !== <span class="string">'undefined'</span>) ? x : <span class="number">0</span>;
    y = (<span class="keyword">typeof</span> y !== <span class="string">'undefined'</span>) ? y : <span class="number">0</span>;
    x = common.clamp(x, <span class="number">0</span>, my.geometry[<span class="number">0</span>] - <span class="number">1</span>);
    y = common.clamp(y, <span class="number">0</span>, my.geometry[<span class="number">1</span>] - <span class="number">1</span>);

    cols = (<span class="keyword">typeof</span> cols !== <span class="string">'undefined'</span>) ? cols : my.geometry[<span class="number">0</span>];
    rows = (<span class="keyword">typeof</span> rows !== <span class="string">'undefined'</span>) ? rows : my.geometry[<span class="number">1</span>];
    <span class="keyword">var</span> x_end = common.clamp(x + cols, <span class="number">0</span>, my.geometry[<span class="number">0</span>]);
    <span class="keyword">var</span> y_end = common.clamp(y + rows, <span class="number">0</span>, my.geometry[<span class="number">1</span>]);

    <span class="keyword">for</span>(<span class="keyword">var</span> j = my.base + y; j &lt; my.base + y_end; j ++) {
      <span class="keyword">for</span>(<span class="keyword">var</span> i = x; i &lt; x_end; i ++) {
        my.buffer[j][i] = glyph(char_value);
      }
    }

    dirty(my.base + y);
    dirty(my.base + y_end);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h3>delete_chars</h3>
<pre><code>@n {number} number of characters to remove on the right</code></pre>
<p>Deletes <code>n</code> characters on the right sliding the whole line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  delete_chars = <span class="keyword">function</span>(n) {
    <span class="keyword">while</span>(n--) {
      my.buffer[my.base + my.cursor.y].splice(my.cursor.x, <span class="number">1</span>);
      my.buffer[my.base + my.cursor.y].push(glyph());
    }
    dirty(my.base + my.cursor.y);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h3>insert_chars</h3>
<pre><code>@n {number} number of blank chars to insert</code></pre>
<p>Inserts <code>n</code> blank characters after the cursor. It clamps the insertion to
the current buffer geometry.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  insert_chars = <span class="keyword">function</span>(n) {
    <span class="keyword">var</span> x = my.cursor.x
    <span class="keyword">while</span>(n-- &amp;&amp; x &lt; my.geometry[<span class="number">0</span>]) {
      my.buffer[my.base + my.cursor.y].splice(x++, <span class="number">0</span>, glyph());
      my.buffer[my.base + my.cursor.y].pop();
    }
    dirty(my.base + my.cursor.y);
  };

  <span class="comment">/****************************************************************************/</span>
  <span class="comment">/*                           PUBLIC METHODS                                 */</span>
  <span class="comment">/****************************************************************************/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h3>resize</h3>
<pre><code>@cols   {number} number of cols for the new geometry
@rows   {number} number of rows for the new geometry
@silent {boolean} silent resize (do not emit event)</code></pre>
<p>Resizes the current term emulator. This basically updates the <code>cols</code> and 
`rows private members</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resize = <span class="keyword">function</span>(cols, rows, silent) {
    <span class="keyword">if</span>(cols &lt; <span class="number">1</span>) cols = <span class="number">1</span>;
    <span class="keyword">if</span>(rows &lt; <span class="number">1</span>) rows = <span class="number">1</span>;

    <span class="keyword">var</span> old = my.geometry;
    my.geometry = [Math.round(cols), Math.round(rows)];

    <span class="comment">/* Resize cols */</span>
    <span class="keyword">var</span> len = my.buffer.length;
    <span class="keyword">while</span>(len--) {
      <span class="keyword">if</span>(my.geometry[<span class="number">0</span>] &gt;= old[<span class="number">0</span>]) {
        <span class="keyword">while</span>(my.buffer[len].length &lt; my.geometry[<span class="number">0</span>]) {
          my.buffer[len].push(glyph());
        }
      }
      <span class="keyword">else</span> {
        <span class="keyword">while</span>(my.buffer[len].length &gt; my.geometry[<span class="number">0</span>]) {
          my.buffer[len].pop();
        }
      }
    }

    <span class="comment">/* setup stops */</span>
    setup_stops(old[<span class="number">0</span>]);

    <span class="comment">/* Resize rows */</span>
    <span class="keyword">while</span>(my.buffer.length &lt; my.geometry[<span class="number">1</span>] + my.base) {
      my.buffer.push(blank_line());
    }
    <span class="keyword">while</span>(my.buffer.length &gt; my.geometry[<span class="number">1</span>] + my.base) {
      my.buffer.pop();
    }
    
    <span class="comment">/* Clamp cursor */</span>
    move_to(my.cursor.x, my.cursor.y);
    <span class="comment">/* Reset scroll region */</span>
    my.scroll.top = <span class="number">0</span>;
    my.scroll.bottom = my.geometry[<span class="number">1</span>] - <span class="number">1</span>;
    <span class="comment">/* Set scoll region as dirty */</span>
    dirty(my.base + my.scroll.top);
    dirty(my.base + my.scroll.bottom);

    <span class="keyword">if</span>(!silent)
      that.emit(<span class="string">'resize'</span>, my.geometry[<span class="number">0</span>], my.geometry[<span class="number">1</span>]);

    <span class="keyword">if</span>(my.dirty.length &gt; <span class="number">0</span>) {
      <span class="comment">/* In the special case of resize, we compute the new slice and force */</span>
      <span class="comment">/* the dirty[1] to be as hight as the old geometry if needed         */</span>
      <span class="keyword">var</span> slice = my.buffer.slice(my.dirty[<span class="number">0</span>], my.dirty[<span class="number">1</span>] + <span class="number">1</span>);
      <span class="keyword">if</span>(old[<span class="number">1</span>] &gt; my.geometry[<span class="number">1</span>])
        dirty(my.base + old[<span class="number">1</span>] - <span class="number">1</span>);
      that.emit(<span class="string">'refresh'</span>, my.dirty, slice, cursor());
      my.dirty = [];
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3>cursor</h3>
<p>Returns the cursor position </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cursor = <span class="keyword">function</span>() {
    <span class="keyword">return</span> {
      x: my.cursor.x,
      y: my.cursor.y
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h3>initialize</h3>
<p>Creates a <code>vt</code> instance and registers handlers and perform an initial
resize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  init = <span class="keyword">function</span>() {
    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                            DATA TRANSFER                               */</span>
    <span class="comment">/**************************************************************************/</span>
    my.pty.on(<span class="string">'data'</span>, <span class="keyword">function</span>(buf) {
      <span class="keyword">try</span> {
        my.vt.read(buf);
      }
      <span class="keyword">catch</span>(err) {
        factory.log().error(err);
      }
      <span class="keyword">if</span>(my.dirty.length &gt; <span class="number">0</span>) {
        that.emit(<span class="string">'refresh'</span>, my.dirty,
                  my.buffer.slice(my.dirty[<span class="number">0</span>], my.dirty[<span class="number">1</span>] + <span class="number">1</span>),
                  cursor());
        my.dirty = [];
      }
    });
    my.vt.on(<span class="string">'print'</span>, <span class="keyword">function</span>(str) {
      <span class="comment">/* Supposed to be of length 1 */</span>
      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i ++) {
        put_char(str[i]);
      }
    });
    my.vt.on(<span class="string">'write'</span>, <span class="keyword">function</span>(data) {
      my.pty.write(data);
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                           CURSOR STORAGE                               */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'save_cursor'</span>, <span class="keyword">function</span>() {
      save_cursor();
    });
    my.vt.on(<span class="string">'restore_cursor'</span>, <span class="keyword">function</span>() {
      restore_cursor();
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                          BUFFER MANAGEMENT                             */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'clear_home'</span>, <span class="keyword">function</span>() {
      factory.log().debug(<span class="string">'vt#clear_home'</span>);
      clear_region();
      move_to(<span class="number">0</span>, <span class="number">0</span>);
    });
    my.vt.on(<span class="string">'clear'</span>, <span class="keyword">function</span>() {
      factory.log().debug(<span class="string">'vt#clear'</span>);
      clear_region();
    });

    my.vt.on(<span class="string">'reset'</span>, <span class="keyword">function</span>() {
      reset();
    });
    my.vt.on(<span class="string">'soft_reset'</span>, <span class="keyword">function</span>() {
      soft_reset();
    });

    my.vt.on(<span class="string">'resize'</span>, <span class="keyword">function</span>(cols, rows) {
      <span class="comment">/* We ignore it for now: 
      /* resize(cols || my.geometry[0], rows || my.geometry[1]); */</span>
    });
    my.vt.on(<span class="string">'fill'</span>, <span class="keyword">function</span>(char_value) {
      clear_region(<span class="number">0</span>, <span class="number">0</span>, my.geometry[<span class="number">0</span>], my.geometry[<span class="number">1</span>], char_value);
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                           CURSOR MOVEMENT                              */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'ring_bell'</span>, <span class="keyword">function</span>() {
      <span class="comment">/* TODO */</span>
    });
    my.vt.on(<span class="string">'cursor_left'</span>, <span class="keyword">function</span>(n) {
      factory.log().debug(<span class="string">'vt#cursor_left '</span> + n);
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span> ) ? n : <span class="number">1</span>;
      move_to(my.cursor.x - n, my.cursor.y);
    });
    my.vt.on(<span class="string">'cursor_down'</span>, <span class="keyword">function</span>(n) {
      factory.log().debug(<span class="string">'vt#cursor_down '</span> + n);
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span> ) ? n : <span class="number">1</span>;
      move_to(my.cursor.x, my.cursor.y + n);
    });
    my.vt.on(<span class="string">'cursor_up'</span>, <span class="keyword">function</span>(n) {
      factory.log().debug(<span class="string">'vt#cursor_up '</span> + n);
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span> ) ? n : <span class="number">1</span>;
      move_to(my.cursor.x, my.cursor.y - n);
    });
    my.vt.on(<span class="string">'cursor_right'</span>, <span class="keyword">function</span>(n) {
      factory.log().debug(<span class="string">'vt#cursor_right '</span> + n);
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span> ) ? n : <span class="number">1</span>;
      move_to(my.cursor.x + n, my.cursor.y);
    });
    my.vt.on(<span class="string">'set_cursor_column'</span>, <span class="keyword">function</span>(x) {
      factory.log().debug(<span class="string">'vt#set_cursor_column '</span> + x);
      <span class="comment">/* Absolute */</span>
      move_to(x, my.cursor.y, <span class="literal">true</span>);
    });
    my.vt.on(<span class="string">'set_cursor_row'</span>, <span class="keyword">function</span>(y) {
      factory.log().debug(<span class="string">'vt#set_cursor_row '</span> + y);
      <span class="comment">/* Absolute */</span>
      move_to(my.cursor.x, y, <span class="literal">true</span>);
    });
    my.vt.on(<span class="string">'set_cursor_position'</span>, <span class="keyword">function</span>(y, x) {
      factory.log().debug(<span class="string">'vt#set_cursor_position '</span> + x + <span class="string">' '</span> + y);
      <span class="comment">/* absolute move (take into account scroll region) */</span>
      move_to(x, y, <span class="literal">true</span>);
    });

    my.vt.on(<span class="string">'report_cursor_position'</span>, <span class="keyword">function</span>() {
      <span class="keyword">var</span> row = my.cursor.x + <span class="number">1</span>;
      <span class="keyword">var</span> col = my.cursor.y + <span class="number">1</span>;
      my.pty.write(<span class="string">'\x1b['</span> + row + <span class="string">';'</span> + col + <span class="string">'R'</span>);
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                             LINE &amp; TABS                                */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'line_feed'</span>, <span class="keyword">function</span>() {
      factory.log().debug(<span class="string">'vt#line_feed'</span>);
      new_line();
    });
    my.vt.on(<span class="string">'reverse_line_feed'</span>, <span class="keyword">function</span>() {
      <span class="keyword">if</span>(my.cursor.y === my.scroll.top)
        scroll(-<span class="number">1</span>);
      <span class="keyword">else</span>
        move_to(my.cursor.x, my.cursor.y - <span class="number">1</span>);
    });
    my.vt.on(<span class="string">'form_feed'</span>, <span class="keyword">function</span>() {
      factory.log().debug(<span class="string">'vt#form_feed'</span>);
      new_line(IS_SET(my.mode, TERM_MODE.CRLF));
    });

    my.vt.on(<span class="string">'forward_tab_stop'</span>, <span class="keyword">function</span>(n) {
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span> ) ? n : <span class="number">1</span>;
      <span class="keyword">while</span>(n--)
        my.cursor.x = next_stop();
    });
    my.vt.on(<span class="string">'backward_tab_stop'</span>, <span class="keyword">function</span>(n) {
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span> ) ? n : <span class="number">1</span>;
      <span class="keyword">while</span>(n--)
        my.cursor.x = prev_stop();
    });
    my.vt.on(<span class="string">'clear_tab_stop'</span>, <span class="keyword">function</span>() {
      <span class="keyword">delete</span> my.tabs[my.cursor.x];
    });
    my.vt.on(<span class="string">'clear_all_tab_stops'</span>, <span class="keyword">function</span>() {
      my.tabs = {};
    });
    my.vt.on(<span class="string">'set_tab_stop_current'</span>, <span class="keyword">function</span>() {
      my.tabs[my.cursor.x] = <span class="literal">true</span>;
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                              CLIPBOARD                                 */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'copy_to_clipboard'</span>, <span class="keyword">function</span>() {
      <span class="comment">/* TODO: ignore for now */</span>
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                               SCROLL                                   */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'scroll_up'</span>, <span class="keyword">function</span>(n) {
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span> ) ? n : <span class="number">1</span>;
      scroll(n);
    });
    my.vt.on(<span class="string">'scroll_down'</span>, <span class="keyword">function</span>(n) {
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span> ) ? n : <span class="number">1</span>;
      scroll(-n);
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                              DELETION                                  */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'erase_below'</span>, <span class="keyword">function</span>() {
      clear_region(my.cursor.x, my.cursor.y, my.geometry[<span class="number">0</span>] - my.cursor.x, <span class="number">1</span>);
      <span class="keyword">if</span>(my.cursor.y + <span class="number">1</span> &gt;= my.geometry[<span class="number">1</span>]) <span class="keyword">return</span>;
      clear_region(<span class="number">0</span>, my.cursor.y + <span class="number">1</span>, 
                   my.geometry[<span class="number">0</span>], my.geometry[<span class="number">1</span>] - (my.cursor.y + <span class="number">1</span>));
    });
    my.vt.on(<span class="string">'erase_above'</span>, <span class="keyword">function</span>() {
      clear_region(<span class="number">0</span>, my.cursor.y, my.cursor.x, <span class="number">1</span>);
      <span class="keyword">if</span>(my.cursor.y - <span class="number">1</span> &lt;= <span class="number">0</span>) <span class="keyword">return</span>;
      clear_region(<span class="number">0</span>, <span class="number">0</span>, my.geometry[<span class="number">0</span>], my.cursor.y - <span class="number">1</span>);
    });
    my.vt.on(<span class="string">'erase_right'</span>, <span class="keyword">function</span>(n) {
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span>) 
                   ? n : my.geometry[<span class="number">0</span>] - my.cursor.x;
      clear_region(my.cursor.x, my.cursor.y, n, <span class="number">1</span>);
    });
    my.vt.on(<span class="string">'erase_left'</span>, <span class="keyword">function</span>() {
      clear_region(<span class="number">0</span>, my.cursor.y, my.cursor.x, <span class="number">1</span>);
    });
    my.vt.on(<span class="string">'erase_line'</span>, <span class="keyword">function</span>() {
      clear_region(<span class="number">0</span>, my.cursor.y, my.geometry[<span class="number">0</span>], <span class="number">1</span>);
    });
    my.vt.on(<span class="string">'delete_lines'</span>, <span class="keyword">function</span>(n) {
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span>) ? n : <span class="number">1</span>;
      <span class="keyword">if</span>(my.cursor.y &lt; my.scroll.top || my.cursor.y &gt; my.scroll.bottom)
        <span class="keyword">return</span>;
      scroll(n);
    });
    my.vt.on(<span class="string">'insert_lines'</span>, <span class="keyword">function</span>(n) {
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span>) ? n : <span class="number">1</span>;
      <span class="keyword">if</span>(my.cursor.y &lt; my.scroll.top || my.cursor.y &gt; my.scroll.bottom)
        <span class="keyword">return</span>;
      scroll(-n);
    });
    my.vt.on(<span class="string">'delete_chars'</span>, <span class="keyword">function</span>(n) {
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span>) ? n : <span class="number">1</span>;
      delete_chars(n);
    });
    my.vt.on(<span class="string">'insert_chars'</span>, <span class="keyword">function</span>() {
      n = (<span class="keyword">typeof</span> n !== <span class="string">'undefined'</span>) ? n : <span class="number">1</span>;
      insert_chars(n);
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                             ANSI MODES                                 */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'set_insert_mode'</span>, <span class="keyword">function</span>(val) {
      <span class="keyword">if</span>(val) my.mode = SET(my.mode, TERM_MODE.INSERT);
      <span class="keyword">else</span> my.mode = UNSET(my.mode, TERM_MODE.INSERT);
    });
    my.vt.on(<span class="string">'set_auto_carriage_return'</span>, <span class="keyword">function</span>(val) {
      <span class="keyword">if</span>(val) my.mode = SET(my.mode, TERM_MODE.CRLF);
      <span class="keyword">else</span> my.mode = UNSET(my.mode, TERM_MODE.CRLF);
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                             DEC MODES                                  */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'set_application_cursor'</span>, <span class="keyword">function</span>(val) {
      <span class="keyword">if</span>(val) my.mode = SET(my.mode, TERM_MODE.APPCURSOR);
      <span class="keyword">else</span> my.mode = UNSET(my.mode, TERM_MODE.APPCURSOR);
      <span class="comment">/* TODO: handle */</span>
    });
    my.vt.on(<span class="string">'set_scroll_region'</span>, <span class="keyword">function</span>(top, bottom) {
      factory.log().out(<span class="string">'{set_scroll_region} '</span> + top + <span class="string">' - '</span> + bottom);
      <span class="keyword">if</span>(top) my.scroll.top = common.clamp(top, <span class="number">0</span>, my.geometry[<span class="number">1</span>] - <span class="number">1</span>);
      <span class="keyword">if</span>(bottom) my.scroll.bottom = common.clamp(bottom, <span class="number">0</span>, my.geometry[<span class="number">1</span>] - <span class="number">1</span>);
    });
    my.vt.on(<span class="string">'set_reverse_video'</span>, <span class="keyword">function</span>(val) {
      <span class="keyword">var</span> m = my.mode;
      <span class="keyword">if</span>(val) m = SET(m, TERM_MODE.REVERSE);
      <span class="keyword">else</span> m = UNSET(m, TERM_MODE.REVERSE);
      <span class="keyword">if</span>(m !== my.mode) {
        my.mode = m;
        <span class="comment">/* TODO: handle */</span>
      }
    });
    my.vt.on(<span class="string">'set_origin_mode'</span>, <span class="keyword">function</span>(val) {
      <span class="keyword">if</span>(val) my.cursor.state = SET(my.cursor.state, CURSOR_STATE.ORIGIN);
      <span class="keyword">else</span> my.cursor.state = UNSET(my.cursor.state, CURSOR_STATE.ORIGIN);
    });
    my.vt.on(<span class="string">'set_wrap_around'</span>, <span class="keyword">function</span>(val) {
      <span class="keyword">if</span>(val) my.mode = SET(my.mode, TERM_MODE.WRAP);
      <span class="keyword">else</span> my.mode = UNSET(my.mode, TERM_MODE.WRAP);
    });
    my.vt.on(<span class="string">'set_cursor_blink'</span>, <span class="keyword">function</span>(val) {
      <span class="comment">/* TODO: ignore for now */</span>
    });
    my.vt.on(<span class="string">'set_cursor_visible'</span>, <span class="keyword">function</span>(val) {
      <span class="keyword">if</span>(val) my.mode = UNSET(my.mode, TERM_MODE.HIDE);
      <span class="keyword">else</span> my.mode = SET(my.mode, TERM_MODE.HIDE);
        <span class="comment">/* TODO: handle */</span>
    });
    my.vt.on(<span class="string">'set_reverse_wrap_around'</span>, <span class="keyword">function</span>() {
      <span class="comment">/* TODO: ignore for now */</span>
    });
    my.vt.on(<span class="string">'set_keyboard_backspace_sends_backspace'</span>, <span class="keyword">function</span>() {
      <span class="comment">/* TODO: ignore for now */</span>
    });
    my.vt.on(<span class="string">'set_scroll_on_output'</span>, <span class="keyword">function</span>() {
      <span class="comment">/* TODO: ignore for now */</span>
    });
    my.vt.on(<span class="string">'set_scroll_on_keystroke'</span>, <span class="keyword">function</span>() {
      <span class="comment">/* TODO: ignore for now */</span>
    });
    my.vt.on(<span class="string">'set_keyboard_meta_sends_escape'</span>, <span class="keyword">function</span>() {
      <span class="comment">/* TODO: ignore for now */</span>
    });
    my.vt.on(<span class="string">'set_keyboard_alt_sends_escape'</span>, <span class="keyword">function</span>() {
      <span class="comment">/* TODO: ignore for now */</span>
    });
    my.vt.on(<span class="string">'set_alternate_mode'</span>, <span class="keyword">function</span>(alt) {
      <span class="keyword">if</span>(alt) {
        my.saved_screen = {
          mode: my.mode,
          buffer: my.buffer,
          base: my.base,
          cursor: my.cursor,
          scroll: my.scroll,
          tabs: my.tabs
        }
        <span class="comment">/* We first clear the buffer so that an empty buffer is transmitted   */</span>
        <span class="comment">/* with the `alternate` event (to be filled right after with the call */</span>
        <span class="comment">/* to `reset`                                                         */</span>
        my.buffer = []; 
        that.emit(<span class="string">'alternate'</span>, <span class="literal">true</span>);
        reset();
        my.mode = SET(my.mode, TERM_MODE.ALTSCREEN);
      }
      <span class="keyword">else</span> {
        <span class="keyword">if</span>(my.saved_screen) {
          my.mode = my.saved_screen.mode;
          my.cursor = my.saved_screen.cursor;
          my.scroll = my.saved_screen.scroll;
          my.tabs = my.saved_screen.tabs;
          my.base = my.saved_screen.base;
          my.buffer = my.saved_screen.buffer;
        }
        my.mode = UNSET(my.mode, TERM_MODE.ALTSCREEN);
        that.emit(<span class="string">'alternate'</span>, <span class="literal">false</span>);
        my.dirty = [];
      }
    });

    my.vt.on(<span class="string">'set_application_keypad'</span>, <span class="keyword">function</span>(val) {
      <span class="keyword">if</span>(val) my.mode = SET(my.mode, TERM_MODE.APPKEYPAD);
      <span class="keyword">else</span> my.mode = UNSET(my.mode, TERM_MODE.APPKEYPAD);
      <span class="comment">/* TODO: handle */</span>
    });
    my.vt.on(<span class="string">'set_window_title'</span>, <span class="keyword">function</span>(title) {
      my.title = title;
      that.emit(<span class="string">'title'</span>, my.title);
    });

    <span class="comment">/**************************************************************************/</span>
    <span class="comment">/*                          CHARACTER ATTRS                               */</span>
    <span class="comment">/**************************************************************************/</span>
    my.vt.on(<span class="string">'char_attr_reset'</span>, <span class="keyword">function</span>() {
      my.cursor.attr = <span class="number">256</span> | (<span class="number">257</span> &lt;<span class="xml"><span class="tag">&lt; <span class="attribute">9</span>) | (<span class="attribute">CHAR_ATTRS.NULL</span> &lt;&lt; <span class="attribute">18</span>);
    });
    <span class="attribute">my.vt.on</span>('<span class="attribute">char_attr_set_bold</span>', <span class="attribute">function</span>(<span class="attribute">val</span>) {
      <span class="attribute">if</span>(<span class="attribute">val</span>) <span class="attribute">my.cursor.attr</span> = <span class="attribute">SET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.BOLD</span> &lt;&lt; <span class="attribute">18</span>);
      <span class="attribute">else</span> <span class="attribute">my.cursor.attr</span> = <span class="attribute">UNSET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.BOLD</span> &lt;&lt; <span class="attribute">18</span>);
    });
    <span class="attribute">my.vt.on</span>('<span class="attribute">char_attr_set_italic</span>', <span class="attribute">function</span>(<span class="attribute">val</span>) {
      <span class="attribute">if</span>(<span class="attribute">val</span>) <span class="attribute">my.cursor.attr</span> = <span class="attribute">SET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.ITALIC</span> &lt;&lt; <span class="attribute">18</span>);
      <span class="attribute">else</span> <span class="attribute">my.cursor.attr</span> = <span class="attribute">UNSET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.ITALIC</span> &lt;&lt; <span class="attribute">18</span>);
    });
    <span class="attribute">my.vt.on</span>('<span class="attribute">char_attr_set_underline</span>', <span class="attribute">function</span>(<span class="attribute">val</span>) {
      <span class="attribute">if</span>(<span class="attribute">val</span>) <span class="attribute">my.cursor.attr</span> = <span class="attribute">SET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.UNDERLINE</span> &lt;&lt; <span class="attribute">18</span>);
      <span class="attribute">else</span> <span class="attribute">my.cursor.attr</span> = <span class="attribute">UNSET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.UNDERLINE</span> &lt;&lt; <span class="attribute">18</span>);
    });
    <span class="attribute">my.vt.on</span>('<span class="attribute">char_attr_set_blink</span>', <span class="attribute">function</span>(<span class="attribute">val</span>) {
      <span class="attribute">if</span>(<span class="attribute">val</span>) <span class="attribute">my.cursor.attr</span> = <span class="attribute">SET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.BLINK</span> &lt;&lt; <span class="attribute">18</span>);
      <span class="attribute">else</span> <span class="attribute">my.cursor.attr</span> = <span class="attribute">UNSET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.BLINK</span> &lt;&lt; <span class="attribute">18</span>);
    });
    <span class="attribute">my.vt.on</span>('<span class="attribute">char_attr_set_reverse</span>', <span class="attribute">function</span>(<span class="attribute">val</span>) {
      <span class="attribute">if</span>(<span class="attribute">val</span>) <span class="attribute">my.cursor.attr</span> = <span class="attribute">SET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.REVERSE</span> &lt;&lt; <span class="attribute">18</span>);
      <span class="attribute">else</span> <span class="attribute">my.cursor.attr</span> = <span class="attribute">UNSET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">CHAR_ATTRS.REVERSE</span> &lt;&lt; <span class="attribute">18</span>);
    });
    <span class="attribute">my.vt.on</span>('<span class="attribute">char_attr_set_invisible</span>', <span class="attribute">function</span>(<span class="attribute">val</span>) {
      /* <span class="attribute">TODO:</span> <span class="attribute">ignore</span> <span class="attribute">for</span> <span class="attribute">now</span> */
    });

    <span class="attribute">my.vt.on</span>('<span class="attribute">char_attr_set_foreground_index</span>', <span class="attribute">function</span>(<span class="attribute">idx</span>) {
      <span class="attribute">if</span>(<span class="attribute">idx</span>) {
        <span class="attribute">my.cursor.attr</span> = <span class="attribute">UNSET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">0x11f</span> &lt;&lt; <span class="attribute">9</span>);
        <span class="attribute">my.cursor.attr</span> = <span class="attribute">SET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">idx</span> &lt;&lt; <span class="attribute">9</span>)
      }
      <span class="attribute">else</span> {
        <span class="attribute">my.cursor.attr</span> = <span class="attribute">UNSET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">0x11f</span> &lt;&lt; <span class="attribute">9</span>);
        <span class="attribute">my.cursor.attr</span> = <span class="attribute">SET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">257</span> &lt;&lt; <span class="attribute">9</span>);
      }
    });
    <span class="attribute">my.vt.on</span>('<span class="attribute">char_attr_set_background_index</span>', <span class="attribute">function</span>(<span class="attribute">idx</span>) {
      <span class="attribute">if</span>(<span class="attribute">idx</span>) {
        <span class="attribute">my.cursor.attr</span> = <span class="attribute">UNSET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">0x11f</span>);
        <span class="attribute">my.cursor.attr</span> = <span class="attribute">SET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">idx</span>)
      }
      <span class="attribute">else</span> {
        <span class="attribute">my.cursor.attr</span> = <span class="attribute">UNSET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">0x11f</span>);
        <span class="attribute">my.cursor.attr</span> = <span class="attribute">SET</span>(<span class="attribute">my.cursor.attr</span>, <span class="attribute">256</span>);
      }
    });

    /* <span class="attribute">Finally</span> <span class="attribute">reset</span> (<span class="attribute">will</span> <span class="attribute">resize</span> <span class="attribute">to</span> <span class="attribute">specified</span> <span class="attribute">geometry</span>) */
    <span class="attribute">reset</span>();
  };

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h4><em>initialization</em></h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  init();

  common.getter(that, <span class="string">'buffer'</span>, my, <span class="string">'buffer'</span>);
  common.getter(that, <span class="string">'title'</span>, my, <span class="string">'title'</span>);
  common.getter(that, <span class="string">'mode'</span>, my, <span class="string">'mode'</span>);
  common.getter(that, <span class="string">'pty'</span>, my, <span class="string">'pty'</span>);

  common.method(that, <span class="string">'resize'</span>, resize, _super);
  common.method(that, <span class="string">'cursor'</span>, cursor, _super);

  <span class="keyword">return</span> that;
};

exports.term = term;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
